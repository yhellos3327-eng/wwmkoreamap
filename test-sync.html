<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Sync Logic Test</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            margin: 0;
        }

        h1 {
            color: #00d4ff;
            margin-bottom: 20px;
        }

        h2 {
            color: #ffd700;
            margin-top: 30px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #0f3460;
        }

        .panel h3 {
            margin-top: 0;
            color: #00d4ff;
        }

        pre {
            background: #0d1b2a;
            padding: 15px;
            border-radius: 8px;
            overflow: auto;
            max-height: 300px;
            font-size: 12px;
            white-space: pre-wrap;
        }

        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #ff6b6b;
        }

        button.secondary {
            background: #0f3460;
        }

        button.secondary:hover {
            background: #1a4a7a;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #34ce57;
        }

        .log {
            background: #0d1b2a;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin: 3px 0;
            padding: 3px 5px;
            border-radius: 3px;
        }

        .log-info {
            color: #00d4ff;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #e94560;
        }

        .log-warn {
            color: #ffc107;
        }

        input,
        textarea {
            background: #0d1b2a;
            border: 1px solid #0f3460;
            color: #eee;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            margin: 5px 0;
        }

        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .test-pass {
            background: rgba(40, 167, 69, 0.2);
            border-left: 4px solid #28a745;
        }

        .test-fail {
            background: rgba(233, 69, 96, 0.2);
            border-left: 4px solid #e94560;
        }

        .section {
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”„ Sync Logic Test Suite</h1>

        <div class="section">
            <h2>1. mergeData í•¨ìˆ˜ í…ŒìŠ¤íŠ¸</h2>
            <button onclick="runMergeTests()">ì „ì²´ ë³‘í•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button onclick="runSpecificTest('markers')" class="secondary">ë§ˆì»¤ ë³‘í•© í…ŒìŠ¤íŠ¸</button>
            <button onclick="runSpecificTest('favorites')" class="secondary">ì¦ê²¨ì°¾ê¸° ë³‘í•© í…ŒìŠ¤íŠ¸</button>
            <button onclick="runSpecificTest('settings')" class="secondary">ì„¤ì • ë³‘í•© í…ŒìŠ¤íŠ¸</button>
            <div id="merge-results"></div>
        </div>

        <div class="section">
            <h2>2. ìˆ˜ë™ ë³‘í•© ì‹œë®¬ë ˆì´í„°</h2>
            <div class="grid">
                <div class="panel">
                    <h3>ğŸ“± ë¡œì»¬ ë°ì´í„° (ê¸°ê¸° A)</h3>
                    <textarea id="local-data" rows="10">{
  "completedMarkers": [{"id": 1, "completedAt": "2025-12-30T10:00:00Z"}, {"id": 2, "completedAt": null}],
  "favorites": [1, 3, 5],
  "settings": {
    "hideCompleted": "true",
    "gpuMode": "false",
    "_updatedAt": {"hideCompleted": "2025-12-30T10:00:00Z", "gpuMode": "2025-12-30T09:00:00Z"}
  }
}</textarea>
                </div>
                <div class="panel">
                    <h3>â˜ï¸ í´ë¼ìš°ë“œ ë°ì´í„° (ê¸°ê¸° B)</h3>
                    <textarea id="cloud-data" rows="10">{
  "completedMarkers": [{"id": 2, "completedAt": "2025-12-30T11:00:00Z"}, {"id": 3, "completedAt": null}],
  "favorites": [2, 3, 7],
  "settings": {
    "hideCompleted": "false",
    "gpuMode": "true",
    "_updatedAt": {"hideCompleted": "2025-12-30T11:00:00Z", "gpuMode": "2025-12-30T08:00:00Z"}
  }
}</textarea>
                </div>
            </div>
            <button onclick="runManualMerge()" class="success">ğŸ”€ ë³‘í•© ì‹¤í–‰</button>
            <div class="panel" style="margin-top: 15px;">
                <h3>âœ… ë³‘í•© ê²°ê³¼</h3>
                <pre id="merge-output">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</pre>
            </div>
        </div>

        <div class="section">
            <h2>3. ì‹¤í–‰ ë¡œê·¸</h2>
            <button onclick="clearLog()" class="secondary">ë¡œê·¸ ì§€ìš°ê¸°</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        // ===== sync.jsì˜ í•µì‹¬ ë¡œì§ë§Œ ì¶”ì¶œ =====

        const getMarkerId = (marker) => {
            if (typeof marker === 'object' && marker !== null) {
                return marker.id;
            }
            return marker;
        };

        const normalizeMarkers = (markers) => {
            if (!Array.isArray(markers)) return [];
            return markers.map(marker => {
                if (typeof marker === 'object' && marker !== null) {
                    return marker;
                }
                return { id: marker, completedAt: null };
            });
        };

        const mergeArrays = (localArr, cloudArr) => {
            const localNormalized = normalizeMarkers(localArr);
            const cloudNormalized = normalizeMarkers(cloudArr);

            const mergedMap = new Map();

            // Add cloud items first
            cloudNormalized.forEach(item => {
                const id = getMarkerId(item);
                mergedMap.set(id, item);
            });

            // Add/override with local items
            localNormalized.forEach(item => {
                const id = getMarkerId(item);
                const existing = mergedMap.get(id);
                if (existing) {
                    if (item.completedAt && existing.completedAt) {
                        const localTime = new Date(item.completedAt).getTime();
                        const cloudTime = new Date(existing.completedAt).getTime();
                        if (localTime >= cloudTime) {
                            mergedMap.set(id, item);
                        }
                    } else if (item.completedAt) {
                        mergedMap.set(id, item);
                    }
                } else {
                    mergedMap.set(id, item);
                }
            });

            return Array.from(mergedMap.values());
        };

        const mergeSettings = (localSettings, cloudSettings) => {
            const merged = {};
            const mergedTimestamps = {};

            const localTimestamps = localSettings._updatedAt || {};
            const cloudTimestamps = cloudSettings._updatedAt || {};

            const allKeys = new Set([
                ...Object.keys(localSettings).filter(k => k !== '_updatedAt'),
                ...Object.keys(cloudSettings).filter(k => k !== '_updatedAt')
            ]);

            allKeys.forEach(key => {
                const localValue = localSettings[key];
                const cloudValue = cloudSettings[key];
                const localTime = localTimestamps[key] ? new Date(localTimestamps[key]).getTime() : 0;
                const cloudTime = cloudTimestamps[key] ? new Date(cloudTimestamps[key]).getTime() : 0;

                if (localValue !== undefined && cloudValue !== undefined) {
                    if (cloudTime > localTime) {
                        merged[key] = cloudValue;
                        mergedTimestamps[key] = cloudTimestamps[key];
                    } else {
                        merged[key] = localValue;
                        mergedTimestamps[key] = localTimestamps[key] || new Date().toISOString();
                    }
                } else if (localValue !== undefined) {
                    merged[key] = localValue;
                    mergedTimestamps[key] = localTimestamps[key] || new Date().toISOString();
                } else if (cloudValue !== undefined) {
                    merged[key] = cloudValue;
                    mergedTimestamps[key] = cloudTimestamps[key] || new Date().toISOString();
                }
            });

            merged._updatedAt = mergedTimestamps;
            return merged;
        };

        const mergeData = (local, cloud) => {
            return {
                completedMarkers: mergeArrays(
                    local?.completedMarkers || [],
                    cloud?.completedMarkers || []
                ),
                favorites: mergeArrays(
                    local?.favorites || [],
                    cloud?.favorites || []
                ),
                settings: mergeSettings(
                    local?.settings || {},
                    cloud?.settings || {}
                )
            };
        };

        // ===== ë¡œê¹… =====
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        window.clearLog = () => {
            document.getElementById('log').innerHTML = '';
        };

        // ===== í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ =====
        const testCases = {
            markers: [
                {
                    name: "ë§ˆì»¤ í•©ì§‘í•© (ì¤‘ë³µ ì—†ìŒ)",
                    local: { completedMarkers: [{ id: 1 }, { id: 2 }] },
                    cloud: { completedMarkers: [{ id: 3 }, { id: 4 }] },
                    expected: result => result.completedMarkers.length === 4,
                    description: "ë¡œì»¬ [1,2] + í´ë¼ìš°ë“œ [3,4] = [1,2,3,4]"
                },
                {
                    name: "ë§ˆì»¤ í•©ì§‘í•© (ì¤‘ë³µ ìˆìŒ)",
                    local: { completedMarkers: [{ id: 1 }, { id: 2 }] },
                    cloud: { completedMarkers: [{ id: 2 }, { id: 3 }] },
                    expected: result => result.completedMarkers.length === 3,
                    description: "ë¡œì»¬ [1,2] + í´ë¼ìš°ë“œ [2,3] = [1,2,3] (ì¤‘ë³µ ì œê±°)"
                },
                {
                    name: "íƒ€ì„ìŠ¤íƒ¬í”„ ë¹„êµ (ë¡œì»¬ ìµœì‹ )",
                    local: { completedMarkers: [{ id: 1, completedAt: "2025-12-30T12:00:00Z" }] },
                    cloud: { completedMarkers: [{ id: 1, completedAt: "2025-12-30T10:00:00Z" }] },
                    expected: result => {
                        const marker = result.completedMarkers.find(m => m.id === 1);
                        return marker && marker.completedAt === "2025-12-30T12:00:00Z";
                    },
                    description: "ë™ì¼ IDì—ì„œ ë¡œì»¬ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ìµœì‹ ì´ë©´ ë¡œì»¬ ê°’ ìœ ì§€"
                },
                {
                    name: "íƒ€ì„ìŠ¤íƒ¬í”„ ë¹„êµ (í´ë¼ìš°ë“œ ìµœì‹ )",
                    local: { completedMarkers: [{ id: 1, completedAt: "2025-12-30T08:00:00Z" }] },
                    cloud: { completedMarkers: [{ id: 1, completedAt: "2025-12-30T12:00:00Z" }] },
                    expected: result => {
                        const marker = result.completedMarkers.find(m => m.id === 1);
                        return marker && marker.completedAt === "2025-12-30T12:00:00Z";
                    },
                    description: "ë™ì¼ IDì—ì„œ í´ë¼ìš°ë“œ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ìµœì‹ ì´ë©´ í´ë¼ìš°ë“œ ê°’ ìœ ì§€"
                },
                {
                    name: "ë¹ˆ ë°ì´í„° ì²˜ë¦¬",
                    local: { completedMarkers: [] },
                    cloud: { completedMarkers: [{ id: 1 }] },
                    expected: result => result.completedMarkers.length === 1,
                    description: "ë¡œì»¬ì´ ë¹„ì–´ìˆì–´ë„ í´ë¼ìš°ë“œ ë°ì´í„° ìœ ì§€"
                }
            ],
            favorites: [
                {
                    name: "ì¦ê²¨ì°¾ê¸° í•©ì§‘í•©",
                    local: { favorites: [1, 2, 3] },
                    cloud: { favorites: [3, 4, 5] },
                    expected: result => result.favorites.length === 5,
                    description: "ë¡œì»¬ [1,2,3] + í´ë¼ìš°ë“œ [3,4,5] = [1,2,3,4,5]"
                }
            ],
            settings: [
                {
                    name: "ì„¤ì • Last Write Wins (í´ë¼ìš°ë“œ ìµœì‹ )",
                    local: {
                        settings: {
                            hideCompleted: "true",
                            _updatedAt: { hideCompleted: "2025-12-30T08:00:00Z" }
                        }
                    },
                    cloud: {
                        settings: {
                            hideCompleted: "false",
                            _updatedAt: { hideCompleted: "2025-12-30T12:00:00Z" }
                        }
                    },
                    expected: result => result.settings.hideCompleted === "false",
                    description: "í´ë¼ìš°ë“œ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ìµœì‹ ì´ë©´ í´ë¼ìš°ë“œ ê°’ ì‚¬ìš©"
                },
                {
                    name: "ì„¤ì • Last Write Wins (ë¡œì»¬ ìµœì‹ )",
                    local: {
                        settings: {
                            gpuMode: "true",
                            _updatedAt: { gpuMode: "2025-12-30T15:00:00Z" }
                        }
                    },
                    cloud: {
                        settings: {
                            gpuMode: "false",
                            _updatedAt: { gpuMode: "2025-12-30T10:00:00Z" }
                        }
                    },
                    expected: result => result.settings.gpuMode === "true",
                    description: "ë¡œì»¬ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ìµœì‹ ì´ë©´ ë¡œì»¬ ê°’ ìœ ì§€"
                },
                {
                    name: "ì„¤ì • ë³‘í•© (ì„œë¡œ ë‹¤ë¥¸ í‚¤)",
                    local: {
                        settings: { keyA: "valueA", _updatedAt: {} }
                    },
                    cloud: {
                        settings: { keyB: "valueB", _updatedAt: {} }
                    },
                    expected: result => result.settings.keyA === "valueA" && result.settings.keyB === "valueB",
                    description: "ì„œë¡œ ë‹¤ë¥¸ ì„¤ì • í‚¤ëŠ” ëª¨ë‘ ë³‘í•©"
                }
            ]
        };

        window.runMergeTests = () => {
            const resultsEl = document.getElementById('merge-results');
            resultsEl.innerHTML = '';
            let passed = 0, failed = 0;

            Object.entries(testCases).forEach(([category, tests]) => {
                tests.forEach(test => {
                    const result = mergeData(test.local, test.cloud);
                    const success = test.expected(result);

                    const div = document.createElement('div');
                    div.className = `test-result ${success ? 'test-pass' : 'test-fail'}`;
                    div.innerHTML = `
                        <strong>${success ? 'âœ…' : 'âŒ'} ${test.name}</strong><br>
                        <small>${test.description}</small>
                    `;
                    resultsEl.appendChild(div);

                    if (success) {
                        passed++;
                        log(`âœ… PASS: ${test.name}`, 'success');
                    } else {
                        failed++;
                        log(`âŒ FAIL: ${test.name}`, 'error');
                        log(`   ê²°ê³¼: ${JSON.stringify(result)}`, 'warn');
                    }
                });
            });

            log(`í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${passed} passed, ${failed} failed`, passed === passed + failed ? 'success' : 'error');
        };

        window.runSpecificTest = (category) => {
            const tests = testCases[category];
            if (!tests) {
                log(`ì¹´í…Œê³ ë¦¬ '${category}' ì—†ìŒ`, 'error');
                return;
            }

            tests.forEach(test => {
                const result = mergeData(test.local, test.cloud);
                const success = test.expected(result);
                log(`${success ? 'âœ…' : 'âŒ'} ${test.name}: ${test.description}`, success ? 'success' : 'error');
                if (!success) {
                    log(`   ê²°ê³¼: ${JSON.stringify(result, null, 2)}`, 'warn');
                }
            });
        };

        window.runManualMerge = () => {
            try {
                const localData = JSON.parse(document.getElementById('local-data').value);
                const cloudData = JSON.parse(document.getElementById('cloud-data').value);

                log('ë³‘í•© ì‹œì‘...', 'info');
                log(`ë¡œì»¬ ë§ˆì»¤: ${localData.completedMarkers?.length || 0}ê°œ`, 'info');
                log(`í´ë¼ìš°ë“œ ë§ˆì»¤: ${cloudData.completedMarkers?.length || 0}ê°œ`, 'info');

                const result = mergeData(localData, cloudData);

                document.getElementById('merge-output').textContent = JSON.stringify(result, null, 2);

                log(`ë³‘í•© ì™„ë£Œ! ë§ˆì»¤ ${result.completedMarkers.length}ê°œ, ì¦ê²¨ì°¾ê¸° ${result.favorites.length}ê°œ`, 'success');

                // ì„¤ì • ë¶„ì„
                if (result.settings) {
                    Object.keys(result.settings).filter(k => k !== '_updatedAt').forEach(key => {
                        const localVal = localData.settings?.[key];
                        const cloudVal = cloudData.settings?.[key];
                        const mergedVal = result.settings[key];
                        if (localVal !== cloudVal) {
                            log(`  ì„¤ì • '${key}': ë¡œì»¬(${localVal}) vs í´ë¼ìš°ë“œ(${cloudVal}) â†’ ${mergedVal}`, 'warn');
                        }
                    });
                }

            } catch (e) {
                log(`JSON íŒŒì‹± ì—ëŸ¬: ${e.message}`, 'error');
                document.getElementById('merge-output').textContent = `ì—ëŸ¬: ${e.message}`;
            }
        };

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸° ë¡œê·¸
        log('í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
        log('sync.jsì˜ mergeData ë¡œì§ì„ ë…ë¦½ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.', 'info');
    </script>
</body>

</html>